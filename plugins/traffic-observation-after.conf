# ------------------------------------------------------------------------
# OWASP CRS Plugin
# Copyright (c) 2021-2025 CRS project. All rights reserved.
#
# The OWASP CRS plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: traffic-observation-plugin
# Plugin description: This is an offical CRS plugin that logs information 
#                     about requests that is not normally logged.
# Rule ID block base: 9,526,000 (range is 1000, thus ID block base +1000)
# Plugin version: 1.0.0

SecRule REQUEST_FILENAME "@unconditionalMatch" \
    "id:9526150,\
    phase:5,\
    pass,\
    t:length,\
    nolog,\
    setvar:tx.traffic-observation-lengthfilename=%{MATCHED_VAR}"

SecRule QUERY_STRING "@unconditionalMatch" \
    "id:9526155,\
    phase:5,\
    pass,\
    t:length,\
    nolog,\
    setvar:tx.traffic-observation-lengthquerystring=%{MATCHED_VAR}"

SecRule &ARGS_GET "@unconditionalMatch" \
    "id:9526165,\
    phase:5,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-numquerystringargs=%{MATCHED_VAR}"

SecRule &REQUEST_HEADERS "@unconditionalMatch" \
    "id:9526170,\
    phase:5,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-numrequestheaders=%{MATCHED_VAR}"

SecRule REQUEST_HEADERS:Cookie "@unconditionalMatch" \
    "id:9526175,\
    phase:5,\
    pass,\
    t:length,\
    nolog,\
    setvar:tx.traffic-observation-lengthrequestcookies=%{MATCHED_VAR}"

SecRule &REQUEST_COOKIES "@unconditionalMatch" \
    "id:9526180,\
    phase:5,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-numrequestcookies=%{MATCHED_VAR}"

SecRule REQUEST_HEADERS:Content-Type "@rx ^([^;]*)" \
    "id:9526185,\
    phase:5,\
    pass,\
    capture,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-reqcontenttype=%{TX.1}"

SecRule &RESPONSE_HEADERS "@unconditionalMatch" \
    "id:9526190,\
    phase:5,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-numresponseheaders=%{MATCHED_VAR}"

SecRule RESPONSE_HEADERS:Content-Type "@rx ^([^;]*)" \
    "id:9526195,\
    phase:5,\
    pass,\
    capture,\
    t:none,\
    nolog,\
    setvar:tx.traffic-observation-respcontenttype=%{TX.1}"

SecAction \
    "id:9526200,\
    phase:5,\
    pass,\
    t:none,\
    log,\
    msg:'Logging traffic-observation-plugin data',\
    logdata:'{ \'Protocol\' : \'%{REQUEST_PROTOCOL}\', \'Method\' : \'%{REQUEST_METHOD}\', \'LenFilename\' : \'%{TX.traffic-observation-lengthfilename}\', \'LenQueryString\' : \'%{TX.traffic-observation-lengthquerystring}\', \'NumQueryStringArgs\' : \'%{TX.traffic-observation-numquerystringargs}\', \'NumReqHeaders\' : \'%{TX.traffic-observation-numrequestheaders}\', \'LenCookies\' : \'%{TX.traffic-observation-lengthrequestcookies}\', \'NumCookies\' : \'%{TX.traffic-observation-numrequestcookies}\', \'ReqContentType\' : \'%{TX.traffic-observation-reqcontenttype}\', \'ReqContentLength\' : \'%{REQUEST_HEADERS.Content-Length}\', \'StatusCode\' : \'%{RESPONSE_STATUS}\', \'NumRespHeaders\' : \'%{TX.traffic-observation-numresponseheaders}\', \'RespContentType\' : \'%{TX.traffic-observation-respcontenttype}\', \'RespContentLength\' : \'%{RESPONSE_HEADERS.Content-Length}\'}',\
    tag:'traffic-observation',\
    ver:'traffic-observation-plugin/1.0.0'"
